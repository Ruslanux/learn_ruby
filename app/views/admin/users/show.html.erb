<% content_for(:page_title, @user.username) %>

<div class="mb-4 sm:mb-6">
  <%= link_to "â† #{t('admin.back_to')} #{t('admin.users')}", admin_users_path, class: "text-gray-600 hover:text-gray-800 text-sm sm:text-base" %>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
  <!-- Main Content -->
  <div class="lg:col-span-2 space-y-4 sm:space-y-6">
    <!-- User Info -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
      <div class="px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2">
        <h3 class="text-base sm:text-lg font-semibold text-gray-800"><%= t('admin.user_details') %></h3>
        <div class="flex flex-wrap gap-2">
          <%= link_to t('admin.edit'), edit_admin_user_path(@user), class: "bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded text-sm transition" %>
          <% if @user != current_user %>
            <%= button_to @user.admin? ? t('admin.revoke_admin') : t('admin.make_admin'),
                toggle_admin_admin_user_path(@user),
                method: :post,
                data: { turbo_confirm: @user.admin? ? t('admin.confirm_revoke_admin', username: @user.username) : t('admin.confirm_make_admin', username: @user.username) },
                class: "#{@user.admin? ? 'bg-red-100 hover:bg-red-200 text-red-700' : 'bg-purple-100 hover:bg-purple-200 text-purple-700'} px-3 py-1 rounded text-sm transition" %>
          <% end %>
        </div>
      </div>

      <div class="p-4 sm:p-6">
        <div class="flex flex-col sm:flex-row sm:items-start gap-4 sm:space-x-6">
          <div class="bg-red-100 text-red-600 rounded-full w-16 h-16 sm:w-20 sm:h-20 flex items-center justify-center text-2xl sm:text-3xl font-bold flex-shrink-0 mx-auto sm:mx-0">
            <%= @user.username[0].upcase %>
          </div>
          <div class="flex-1 text-center sm:text-left">
            <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:space-x-3 justify-center sm:justify-start">
              <h2 class="text-xl sm:text-2xl font-bold text-gray-800"><%= @user.username %></h2>
              <% if @user.admin? %>
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800 self-center">
                  <%= t('admin.admin_role') %>
                </span>
              <% end %>
            </div>
            <p class="text-gray-500 mt-1 text-sm sm:text-base"><%= @user.email %></p>

            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-4 mt-4 sm:mt-6">
              <div class="text-center p-2 sm:p-3 bg-gray-50 rounded-lg">
                <p class="text-xl sm:text-2xl font-bold text-red-600"><%= @user.level %></p>
                <p class="text-xs sm:text-sm text-gray-500"><%= t('admin.level') %></p>
              </div>
              <div class="text-center p-2 sm:p-3 bg-gray-50 rounded-lg">
                <p class="text-xl sm:text-2xl font-bold text-gray-800"><%= @user.total_points %></p>
                <p class="text-xs sm:text-sm text-gray-500"><%= t('admin.points') %></p>
              </div>
              <div class="text-center p-2 sm:p-3 bg-gray-50 rounded-lg">
                <p class="text-xl sm:text-2xl font-bold text-orange-500">ðŸ”¥ <%= @user.current_streak %></p>
                <p class="text-xs sm:text-sm text-gray-500"><%= t('profile.current_streak') %></p>
              </div>
              <div class="text-center p-2 sm:p-3 bg-gray-50 rounded-lg">
                <p class="text-xl sm:text-2xl font-bold text-gray-800"><%= @user.longest_streak %></p>
                <p class="text-xs sm:text-sm text-gray-500"><%= t('profile.longest_streak') %></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Submissions -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
      <div class="px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200">
        <h3 class="text-base sm:text-lg font-semibold text-gray-800"><%= t('admin.recent_submissions') %></h3>
      </div>

      <!-- Desktop table -->
      <div class="hidden sm:block">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"><%= t('admin.exercise') %></th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"><%= t('admin.status') %></th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"><%= t('admin.time') %></th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <% @submissions.each do |submission| %>
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4">
                  <%= link_to submission.exercise.title, admin_exercise_path(submission.exercise), class: "text-gray-800 hover:underline" %>
                </td>
                <td class="px-6 py-4">
                  <% if submission.passed %>
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800"><%= t('admin.pass') %></span>
                  <% else %>
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800"><%= t('admin.fail') %></span>
                  <% end %>
                </td>
                <td class="px-6 py-4 text-gray-500 text-sm">
                  <%= time_ago_in_words(submission.created_at) %> <%= t('common.ago') %>
                </td>
              </tr>
            <% end %>
            <% if @submissions.empty? %>
              <tr>
                <td colspan="3" class="px-6 py-8 text-center text-gray-500"><%= t('admin.no_submissions_yet') %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Mobile list -->
      <div class="sm:hidden divide-y divide-gray-200">
        <% @submissions.each do |submission| %>
          <div class="px-4 py-3 flex items-center justify-between">
            <div class="min-w-0 flex-1">
              <%= link_to submission.exercise.title, admin_exercise_path(submission.exercise), class: "text-gray-800 hover:underline text-sm truncate block" %>
              <span class="text-xs text-gray-500"><%= time_ago_in_words(submission.created_at) %></span>
            </div>
            <% if submission.passed %>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800 ml-2"><%= t('admin.pass') %></span>
            <% else %>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800 ml-2"><%= t('admin.fail') %></span>
            <% end %>
          </div>
        <% end %>
        <% if @submissions.empty? %>
          <div class="px-4 py-8 text-center text-gray-500 text-sm"><%= t('admin.no_submissions_yet') %></div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="space-y-4 sm:space-y-6">
    <!-- Account Info -->
    <div class="bg-white rounded-lg shadow p-4 sm:p-6">
      <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4"><%= t('admin.account_info') %></h3>
      <dl class="space-y-2 sm:space-y-3 text-sm">
        <div class="flex justify-between">
          <dt class="text-gray-500"><%= t('admin.joined') %></dt>
          <dd class="text-gray-800"><%= l(@user.created_at, format: :short) %></dd>
        </div>
        <div class="flex justify-between">
          <dt class="text-gray-500"><%= t('admin.last_active') %></dt>
          <dd class="text-gray-800">
            <% if @user.last_activity_date %>
              <%= l(@user.last_activity_date, format: :short) %>
            <% else %>
              <%= t('admin.never') %>
            <% end %>
          </dd>
        </div>
        <div class="flex justify-between">
          <dt class="text-gray-500"><%= t('admin.rank') %></dt>
          <dd class="text-gray-800">#<%= @user.rank %></dd>
        </div>
        <div class="flex justify-between">
          <dt class="text-gray-500"><%= t('admin.stats.total_submissions') %></dt>
          <dd class="text-gray-800"><%= @user.code_submissions.count %></dd>
        </div>
        <div class="flex justify-between">
          <dt class="text-gray-500"><%= t('admin.completed') %></dt>
          <dd class="text-gray-800"><%= t('admin.n_exercises', count: @user.completed_exercises_count) %></dd>
        </div>
      </dl>
    </div>

    <!-- Achievements -->
    <div class="bg-white rounded-lg shadow p-4 sm:p-6">
      <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4"><%= t('profile.achievements') %> (<%= @achievements.count %>)</h3>
      <% if @achievements.any? %>
        <div class="flex flex-wrap gap-2">
          <% @achievements.each do |achievement| %>
            <span class="text-xl sm:text-2xl" title="<%= achievement.name %>"><%= achievement.badge_icon %></span>
          <% end %>
        </div>
      <% else %>
        <p class="text-gray-500 text-sm"><%= t('admin.no_achievements_yet') %></p>
      <% end %>
    </div>

    <!-- Recent Progress -->
    <div class="bg-white rounded-lg shadow p-4 sm:p-6">
      <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4"><%= t('admin.recent_completions') %></h3>
      <% if @progress.any? %>
        <ul class="space-y-2">
          <% @progress.each do |p| %>
            <li class="flex items-center text-sm">
              <span class="text-green-500 mr-2">âœ“</span>
              <span class="text-gray-800 truncate"><%= truncate(p.exercise.title, length: 25) %></span>
            </li>
          <% end %>
        </ul>
      <% else %>
        <p class="text-gray-500 text-sm"><%= t('admin.no_completed_yet') %></p>
      <% end %>
    </div>
  </div>
</div>
